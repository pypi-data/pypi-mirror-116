(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([[66054],{23682:(e,t,n)=>{"use strict";function r(e,t){if(t.length<e)throw new TypeError(e+" argument"+(e>1?"s":"")+" required, but only "+t.length+" present")}n.d(t,{Z:()=>r})},90394:(e,t,n)=>{"use strict";function r(e){if(null===e||!0===e||!1===e)return NaN;var t=Number(e);return isNaN(t)?t:t<0?Math.ceil(t):Math.floor(t)}n.d(t,{Z:()=>r})},59699:(e,t,n)=>{"use strict";n.d(t,{Z:()=>a});var r=n(90394),s=n(39244),i=n(23682),o=36e5;function a(e,t){(0,i.Z)(2,arguments);var n=(0,r.Z)(t);return(0,s.Z)(e,n*o)}},39244:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var r=n(90394),s=n(34327),i=n(23682);function o(e,t){(0,i.Z)(2,arguments);var n=(0,s.Z)(e).getTime(),o=(0,r.Z)(t);return new Date(n+o)}},93752:(e,t,n)=>{"use strict";n.d(t,{Z:()=>i});var r=n(34327),s=n(23682);function i(e){(0,s.Z)(1,arguments);var t=(0,r.Z)(e);return t.setHours(23,59,59,999),t}},70390:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});var r=n(93752);function s(){return(0,r.Z)(Date.now())}},61334:(e,t,n)=>{"use strict";function r(){var e=new Date,t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),s=new Date(0);return s.setFullYear(t,n,r-1),s.setHours(23,59,59,999),s}n.d(t,{Z:()=>r})},59429:(e,t,n)=>{"use strict";n.d(t,{Z:()=>i});var r=n(34327),s=n(23682);function i(e){(0,s.Z)(1,arguments);var t=(0,r.Z)(e);return t.setHours(0,0,0,0),t}},27088:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});var r=n(59429);function s(){return(0,r.Z)(Date.now())}},83008:(e,t,n)=>{"use strict";function r(){var e=new Date,t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),s=new Date(0);return s.setFullYear(t,n,r-1),s.setHours(0,0,0,0),s}n.d(t,{Z:()=>r})},34327:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});var r=n(23682);function s(e){(0,r.Z)(1,arguments);var t=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===t?new Date(e.getTime()):"number"==typeof e||"[object Number]"===t?new Date(e):("string"!=typeof e&&"[object String]"!==t||"undefined"==typeof console||(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://git.io/fjule"),console.warn((new Error).stack)),new Date(NaN))}},11950:(e,t,n)=>{"use strict";n.d(t,{l:()=>r});const r=async(e,t)=>new Promise((n=>{const r=t(e,(e=>{r(),n(e)}))}))},81582:(e,t,n)=>{"use strict";n.d(t,{LZ:()=>r,pB:()=>s,SO:()=>i,iJ:()=>o,Nn:()=>a,Ny:()=>u,T0:()=>c});const r=32143==n.j?["migration_error","setup_error","setup_retry"]:null,s=e=>e.callApi("GET","config/config_entries/entry"),i=(e,t,n)=>e.callWS({type:"config_entries/update",entry_id:t,...n}),o=(e,t)=>e.callApi("DELETE",`config/config_entries/entry/${t}`),a=(e,t)=>e.callApi("POST",`config/config_entries/entry/${t}/reload`),u=(e,t)=>e.callWS({type:"config_entries/disable",entry_id:t,disabled_by:"user"}),c=(e,t)=>e.callWS({type:"config_entries/disable",entry_id:t,disabled_by:null})},55424:(e,t,n)=>{"use strict";n.d(t,{Bm:()=>g,o1:()=>f,iK:()=>p,rl:()=>m,ZC:()=>b,_Z:()=>v,Jj:()=>w,UB:()=>S});var r=n(59699),s=n(27088),i=n(83008),o=n(70390),a=n(61334),u=n(95282),c=n(11950),l=n(81582),_=n(74186),d=n(58763);const y=[],g=()=>({stat_energy_from:"",stat_cost:null,entity_energy_from:null,entity_energy_price:null,number_energy_price:null}),f=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_to:null,entity_energy_price:null,number_energy_price:null}),p=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),m=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),h=e=>e.callWS({type:"energy/info"}),b=e=>e.callWS({type:"energy/get_prefs"}),v=async(e,t)=>{const n=e.callWS({type:"energy/save_prefs",...t});return Z(e),n},w=e=>{const t={};for(const n of e.energy_sources)n.type in t?t[n.type].push(n):t[n.type]=[n];return t},Z=e=>{y.forEach((t=>{const n=S(e,{key:t});n.clearPrefs(),n._active&&n.refresh()}))},S=(e,t={})=>{let n="_energy";if(t.key){if(!t.key.startsWith("energy_"))throw new Error("Key need to start with energy_");n=`_${t.key}`}if(e.connection[n])return e.connection[n];y.push(t.key);const g=(0,u._)(e.connection,n,(async()=>{if(g.prefs||(g.prefs=await b(e)),g._refreshTimeout&&clearTimeout(g._refreshTimeout),g._active&&(!g.end||g.end>new Date)){const e=new Date;e.getMinutes()>=20&&e.setHours(e.getHours()+1),e.setMinutes(20,0,0),g._refreshTimeout=window.setTimeout((()=>g.refresh()),e.getTime()-Date.now())}return(async(e,t,n,s)=>{const[i,o,a]=await Promise.all([(0,l.pB)(e),(0,c.l)(e.connection,_.LM),h(e)]),u=i.find((e=>"co2signal"===e.domain));let y;if(u)for(const t of o){if(t.config_entry_id!==u.entry_id)continue;const n=e.states[t.entity_id];if(n&&"%"===n.attributes.unit_of_measurement){y=n.entity_id;break}}const g=[];void 0!==y&&g.push(y);for(const e of t.energy_sources)if("solar"!==e.type){for(const t of e.flow_from){g.push(t.stat_energy_from),t.stat_cost&&g.push(t.stat_cost);const e=a.cost_sensors[t.stat_energy_from];e&&g.push(e)}for(const t of e.flow_to){g.push(t.stat_energy_to),t.stat_compensation&&g.push(t.stat_compensation);const e=a.cost_sensors[t.stat_energy_to];e&&g.push(e)}}else g.push(e.stat_energy_from);return{start:n,end:s,info:a,prefs:t,stats:await(0,d.dL)(e,(0,r.Z)(n,-1),s,g),co2SignalConfigEntry:u,co2SignalEntity:y}})(e,g.prefs,g.start,g.end)})),f=g.subscribe;g.subscribe=e=>{const t=f(e);return g._active++,()=>{g._active--,g._active<1&&(clearTimeout(g._refreshTimeout),g._refreshTimeout=void 0),t()}},g._active=0,g.prefs=t.prefs;const p=new Date;g.start=p.getHours()>0?(0,s.Z)():(0,i.Z)(),g.end=p.getHours()>0?(0,o.Z)():(0,a.Z)();const m=()=>{g._updatePeriodTimeout=window.setTimeout((()=>{g.start=(0,s.Z)(),g.end=(0,o.Z)(),m()}),(0,r.Z)((0,o.Z)(),1).getTime()-Date.now())};return m(),g.clearPrefs=()=>{g.prefs=void 0},g.setPeriod=(e,t)=>{var n;g.start=e,g.end=t,g.start.getTime()!==(0,s.Z)().getTime()||(null===(n=g.end)||void 0===n?void 0:n.getTime())!==(0,o.Z)().getTime()||g._updatePeriodTimeout?g._updatePeriodTimeout&&(clearTimeout(g._updatePeriodTimeout),g._updatePeriodTimeout=void 0):m()},g}},74186:(e,t,n)=>{"use strict";n.d(t,{eD:()=>o,Mw:()=>a,vA:()=>u,L3:()=>c,Nv:()=>l,z3:()=>_,LM:()=>g});var r=n(95282),s=n(91741),i=n(38346);const o=(e,t)=>t.find((t=>e.states[t.entity_id]&&"battery"===e.states[t.entity_id].attributes.device_class)),a=(e,t)=>t.find((t=>e.states[t.entity_id]&&"battery_charging"===e.states[t.entity_id].attributes.device_class)),u=(e,t)=>{if(t.name)return t.name;const n=e.states[t.entity_id];return n?(0,s.C)(n):null},c=(e,t)=>e.callWS({type:"config/entity_registry/get",entity_id:t}),l=(e,t,n)=>e.callWS({type:"config/entity_registry/update",entity_id:t,...n}),_=(e,t)=>e.callWS({type:"config/entity_registry/remove",entity_id:t}),d=e=>e.sendMessagePromise({type:"config/entity_registry/list"}),y=(e,t)=>e.subscribeEvents((0,i.D)((()=>d(e).then((e=>t.setState(e,!0)))),500,!0),"entity_registry_updated"),g=(e,t)=>(0,r.B)("_entityRegistry",d,y,e,t)},58763:(e,t,n)=>{"use strict";n.d(t,{vq:()=>u,_J:()=>c,Nu:()=>_,uR:()=>d,dL:()=>y,Kj:()=>g,q6:()=>f,Nw:()=>p,m2:()=>m});var r=n(29171),s=n(22311),i=n(91741);const o=["climate","humidifier","water_heater"],a=["temperature","current_temperature","target_temp_low","target_temp_high","hvac_action","humidity","mode"],u=(e,t,n,r,s=!1,i,o=!0)=>{let a="history/period";return n&&(a+="/"+n.toISOString()),a+="?filter_entity_id="+t,r&&(a+="&end_time="+r.toISOString()),s&&(a+="&skip_initial_state"),void 0!==i&&(a+=`&significant_changes_only=${Number(i)}`),o&&(a+="&minimal_response"),e.callApi("GET",a)},c=(e,t,n,r)=>e.callApi("GET",`history/period/${t.toISOString()}?end_time=${n.toISOString()}&minimal_response${r?`&filter_entity_id=${r}`:""}`),l=(e,t)=>e.state===t.state&&(!e.attributes||!t.attributes||a.every((n=>e.attributes[n]===t.attributes[n]))),_=(e,t,n)=>{const u={},c=[];if(!t)return{line:[],timeline:[]};t.forEach((t=>{if(0===t.length)return;const o=t.find((e=>e.attributes&&"unit_of_measurement"in e.attributes));let a;a=o?o.attributes.unit_of_measurement:{climate:e.config.unit_system.temperature,counter:"#",humidifier:"%",input_number:"#",number:"#",water_heater:e.config.unit_system.temperature}[(0,s.N)(t[0])],a?a in u?u[a].push(t):u[a]=[t]:c.push(((e,t,n)=>{const s=[],o=n.length-1;for(const i of n)s.length>0&&i.state===s[s.length-1].state||(i.entity_id||(i.attributes=n[o].attributes,i.entity_id=n[o].entity_id),s.push({state_localize:(0,r.D)(e,i,t),state:i.state,last_changed:i.last_changed}));return{name:(0,i.C)(n[0]),entity_id:n[0].entity_id,data:s}})(n,e.locale,t))}));return{line:Object.keys(u).map((e=>((e,t)=>{const n=[];for(const e of t){const t=e[e.length-1],r=(0,s.N)(t),u=[];for(const t of e){let e;if(o.includes(r)){e={state:t.state,last_changed:t.last_updated,attributes:{}};for(const n of a)n in t.attributes&&(e.attributes[n]=t.attributes[n])}else e=t;u.length>1&&l(e,u[u.length-1])&&l(e,u[u.length-2])||u.push(e)}n.push({domain:r,name:(0,i.C)(t),entity_id:t.entity_id,states:u})}return{unit:e,identifier:t.map((e=>e[0].entity_id)).join(""),data:n}})(e,u[e]))),timeline:c}},d=(e,t)=>e.callWS({type:"history/list_statistic_ids",statistic_type:t}),y=(e,t,n,r)=>e.callWS({type:"history/statistics_during_period",start_time:t.toISOString(),end_time:null==n?void 0:n.toISOString(),statistic_ids:r}),g=e=>{if(!e||e.length<2)return null;const t=e[e.length-1].sum;if(null===t)return null;const n=e[0].sum;return null===n?t:t-n},f=(e,t)=>{let n=null;for(const r of t){if(!(r in e))continue;const t=g(e[r]);null!==t&&(null===n?n=t:n+=t)}return n},p=(e,t)=>e.some((e=>null!==e[t])),m=(e,t)=>{let n=null;if(0===t.length||0===e.length)return null;const r=(e=>{const t={};return e.forEach((e=>{if(0===e.length)return;let n=null;e.forEach((e=>{if(null===e.sum)return;if(null===n)return void(n=e.sum);const r=e.sum-n;e.start in t?t[e.start]+=r:t[e.start]=r,n=e.sum}))})),t})(t);return e.forEach((e=>{const t=r[e.start];void 0!==t&&(null===n?n=t*(e.mean/100):n+=t*(e.mean/100))})),n}},66054:(e,t,n)=>{"use strict";n.r(t),n.d(t,{EnergyStrategy:()=>s});var r=n(55424);class s{static async generateView(e){const t=e.hass,s={cards:[]};let i;try{i=await(0,r.ZC)(t)}catch(e){return"not_found"===e.code?(async()=>(await Promise.all([n.e(78161),n.e(88985),n.e(91657),n.e(33762),n.e(77521),n.e(10363)]).then(n.bind(n,55158)),{type:"panel",cards:[{type:"custom:energy-setup-wizard-card"}]}))():(s.cards.push({type:"markdown",content:`An error occured while fetching your energy preferences: ${e.message}.`}),s)}s.type="sidebar";const o=i.energy_sources.find((e=>"grid"===e.type)),a=o&&o.flow_to.length,u=i.energy_sources.some((e=>"solar"===e.type));return e.narrow&&s.cards.push({type:"energy-date-selection",collection_key:"energy_dashboard",view_layout:{position:"sidebar"}}),o&&s.cards.push({title:"Energy usage",type:"energy-usage-graph",collection_key:"energy_dashboard"}),u&&s.cards.push({title:"Solar production",type:"energy-solar-graph",collection_key:"energy_dashboard"}),o&&s.cards.push({title:"Energy distribution",type:"energy-distribution",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),(o||u)&&s.cards.push({title:"Sources",type:"energy-sources-table",collection_key:"energy_dashboard"}),a&&s.cards.push({type:"energy-grid-neutrality-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),u&&a&&s.cards.push({type:"energy-solar-consumed-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),o&&s.cards.push({type:"energy-carbon-consumed-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),i.device_consumption.length&&s.cards.push({title:"Monitor individual devices",type:"energy-devices-graph",collection_key:"energy_dashboard"}),s}}}}]);
//# sourceMappingURL=fb15f1fe.js.map