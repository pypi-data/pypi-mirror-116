#!/usr/bin/env python3
# This file is placed in the Public Domain.

import os, sys ; sys.path.insert(0, os.getcwd())

import ob
import os
import readline
import sys
import termios
import time

ob.wd = os.path.expanduser("~/.bot")


class Kernel(ob.krn.Runtime):

    def error(self, txt):
        print(txt)

    def log(self, txt):
        if self.opts("v"):
            print(txt)
            sys.stdout.flush()


class CLI(ob.hdl.Client):

    def handle(self, clt, e):
        e.wait()

    def raw(self, txt):
        print(txt)

    def say(self, channel, txt):
        self.raw(txt)
        sys.stdout.flush()


class Console(CLI):

    def handle(self, clt, e):
        k.put(e)
        e.wait()

    def poll(self):
        return input("> ")


clt = CLI()
k = Kernel()


import bot.all
import botd.all

def wrap(func):
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except KeyboardInterrupt:
        pass
    except PermissionError as ex:
        print(str(ex))
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)


def main():
    k.boot()
    k.scan("bot,botd")
    if "txt" in k.cfg and k.cfg.txt:
        return k.cmd(k.cfg.otxt)
    if k.opts("c") or ("m" in k.cfg and k.cfg.m):
        k.start()
        csl = Console()
        csl.start()
        if "m" in k.cfg and k.cfg.m:
            k.init(k.cfg.m)
        k.wait()

wrap(main)
